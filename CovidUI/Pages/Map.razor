@page "/map"
@using System.Net.Http
@using CovidUI.Responses
@inject HttpClient Http
@inject IJSRuntime JSRuntime

<h1>Display Map</h1>
<div id="map" style="height:500px;width:100%;"> </div>

@code {

    private int active;
    private int recovered;


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {

            var countryInfo = await GetCountriesWithData();
            await JSRuntime.InvokeVoidAsync("loadBingMap", countryInfo);
        }
    }

    [JSInvokable]
    public async Task FetchCountryData(string countryCode)
    {

        var countryUrl = $"http://localhost:5000/api/Country/latest/{countryCode}";
        var response = await Http.GetAsync(countryUrl);
        var responseContent = await response.Content.ReadAsStringAsync();
        var data = System.Text.Json.JsonSerializer.Deserialize<CountryData>(responseContent);
        active = data.ActiveCases;
        recovered = data.Recovered;

    }

    private async Task<string> GetCountriesWithData()
    {
        var countryInfoUrl = "http://localhost:5000/api/Country/countries";
        var response = await Http.GetAsync(countryInfoUrl);
        var responseContent = await response.Content.ReadAsStringAsync();
        //var data = System.Text.Json.JsonSerializer.Deserialize<List<CountryInfo>>(responseContent);

        return responseContent;
    }
}
